version: 0.2

phases:
  install:
    on-failure: ABORT
    runtime-versions:
      python: 3.11
    commands:
      - echo "1. Installing dependencies..."
      - pip3 install -r requirements.txt
      - pip3 install pylint

  pre_build:
    on-failure: ABORT
    commands:
      - echo "2. Signing in to Amazon ECR..."
      - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 214057697186.dkr.ecr.us-east-1.amazonaws.com

  build:
    on-failure: ABORT
    commands:
      - echo "3. Running static code analysis..."
      - pylint --fail-under=6 app.py

      - echo "4. Building the Docker image..."
      - docker build -t eks-ecr .
      - docker tag eks-ecr:latest 214057697186.dkr.ecr.us-east-1.amazonaws.com/eks-ecr:latest
      - docker tag eks-ecr:latest 214057697186.dkr.ecr.us-east-1.amazonaws.com/eks-ecr:1.$CODEBUILD_BUILD_NUMBER
  
  post_build:
    on-failure: ABORT
    commands:
      - echo "5. Pushing the Docker image to Amazon ECR..."
      - docker push 214057697186.dkr.ecr.us-east-1.amazonaws.com/eks-ecr:latest

      - echo "6. Generate Docker image information for ECS Task Definition..."
      - printf '[{"name":"%s","imageUri":"%s"}]' eks-ecr 214057697186.dkr.ecr.us-east-1.amazonaws.com/eks-ecr:1.$CODEBUILD_BUILD_NUMBER > imagedefinitions.json

artifacts:
    files: imagedefinitions.json
