version: 0.2

env:
  variables:
    IMAGE: eks-ecr
    VERSION: 1.0
  # The REPOSITORY variable is now constructed dynamically
  # using built-in CodeBuild environment variables.
  # AWS_ACCOUNT_ID: The AWS account ID of the build project.
  # AWS_DEFAULT_REGION: The AWS Region of the build project.
  REPOSITORY: 214057697186.dkr.ecr.us-east-1.amazonaws.com

phases:
  install:
    on-failure: ABORT
    runtime-versions:
      # It's better to specify a major version like 3.11, 3.10, etc.
      # instead of a generic '3.x'
      python: 3.11
    commands:
      - echo "1. Installing dependencies..."
      # Install dependencies from requirements.txt first
      - pip3 install -r requirements.txt
      - pip3 install pylint

  pre_build:
    on-failure: ABORT
    commands:
      - echo "2. Signing in to Amazon ECR..."
      # Adding a debug step to print the REPOSITORY variable to the logs.
      # This helps confirm that the AWS_ACCOUNT_ID and AWS_DEFAULT_REGION are being populated.
      - echo "Attempting to log in to repository"
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $REPOSITORY

  build:
    on-failure: ABORT
    commands:
      - echo "3. Running static code analysis..."
      - pylint --fail-under=6 app.py

      - echo "4. Building the Docker image..."
      - docker build -t $REPOSITORY/$IMAGE:$VERSION.$CODEBUILD_BUILD_NUMBER -t $REPOSITORY/$IMAGE:latest .

  post_build:
    on-failure: ABORT
    commands:
      - echo "5. Pushing the Docker image to Amazon ECR..."
      - docker push --all-tags $REPOSITORY/$IMAGE

      - echo "6. Generate Docker image information for ECS Task Definition..."
      - printf '[{"name":"%s","imageUri":"%s"}]' $IMAGE $REPOSITORY/$IMAGE:$VERSION.$CODEBUILD_BUILD_NUMBER > imagedefinitions.json

artifacts:
    files: imagedefinitions.json
